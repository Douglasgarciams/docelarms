{% extends 'base.html' %}
{% load humanize %}
{% load static %} {% block title %}Encontre o Imóvel dos Seus Sonhos{% endblock %}

{% block content %}

<header id="heroCarousel" class="carousel slide" data-bs-ride="carousel">

    <div class="carousel-indicators">
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="4" aria-label="Slide 5"></button>
    </div>

    <div class="carousel-inner">
        
        <div class="carousel-item active" style="background-image: url('{% static 'img/carousel/capa1.jpg' %}')">
            <div class="carousel-caption">
                <div class="text-center">
                    <h1 class="display-3 fw-bold mb-4">A Chave para a Sua Nova Vida</h1>
                    
                    <div class="p-4 rounded-3" style="background-color: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                        <form method="GET" action="" class="row g-2 align-items-center justify-content-center">
                            
                            <div class="col-md-4">
                                <select name="finalidade" class="form-select form-select-lg">
                                    <option value="">Comprar ou Alugar?</option>
                                    <option value="VENDA" {% if valores_filtro.finalidade|default:'' == 'VENDA' %}selected{% endif %}>Comprar</option>
                                    <option value="ALUGUEL" {% if valores_filtro.finalidade|default:'' == 'ALUGUEL' %}selected{% endif %}>Alugar</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="cidade" id="hero_cidade" class="form-select form-select-lg">
                                    <option value="">Cidade</option>
                                    {% for cidade in cidades %}
                                        <option value="{{ cidade.id }}" {% if valores_filtro.cidade|default:'' == cidade.id|stringformat:"s" %}selected{% endif %}>{{ cidade.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="bairro" id="hero_bairro" class="form-select form-select-lg" disabled>
                                    <option value="">Bairro</option>
                                    </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100">Buscar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="carousel-item" style="background-image: url('{% static 'img/carousel/capa2.jpg' %}')">
            <div class="carousel-caption">
                <div class="text-center">
                    <h1 class="display-3 fw-bold mb-4">Encontre seu Lar Ideal</h1>
                    
                    <div class="p-4 rounded-3" style="background-color: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                        <form method="GET" action="" class="row g-2 align-items-center justify-content-center">

                            <div class="col-md-4">
                                <select name="finalidade" class="form-select form-select-lg">
                                    <option value="">Comprar ou Alugar?</option>
                                    <option value="VENDA" {% if valores_filtro.finalidade|default:'' == 'VENDA' %}selected{% endif %}>Comprar</option>
                                    <option value="ALUGUEL" {% if valores_filtro.finalidade|default:'' == 'ALUGUEL' %}selected{% endif %}>Alugar</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="cidade" id="hero_cidade_2" class="form-select form-select-lg"> <option value="">Cidade</option>
                                    {% for cidade in cidades %}
                                        <option value="{{ cidade.id }}" {% if valores_filtro.cidade|default:'' == cidade.id|stringformat:"s" %}selected{% endif %}>{{ cidade.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="bairro" id="hero_bairro_2" class="form-select form-select-lg" disabled> <option value="">Bairro</option>
                                    </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100">Buscar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="carousel-item" style="background-image: url('{% static 'img/carousel/capa3.jpg' %}')">
            <div class="carousel-caption">
                <div class="text-center">
                    <h1 class="display-3 fw-bold mb-4">Investimento Seguro</h1>
                    
                    <div class="p-4 rounded-3" style="background-color: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                        <form method="GET" action="" class="row g-2 align-items-center justify-content-center">

                            <div class="col-md-4">
                                <select name="finalidade" class="form-select form-select-lg">
                                    <option value="">Comprar ou Alugar?</option>
                                    <option value="VENDA" {% if valores_filtro.finalidade|default:'' == 'VENDA' %}selected{% endif %}>Comprar</option>
                                    <option value="ALUGUEL" {% if valores_filtro.finalidade|default:'' == 'ALUGUEL' %}selected{% endif %}>Alugar</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="cidade" id="hero_cidade_3" class="form-select form-select-lg"> <option value="">Cidade</option>
                                    {% for cidade in cidades %}
                                        <option value="{{ cidade.id }}" {% if valores_filtro.cidade|default:'' == cidade.id|stringformat:"s" %}selected{% endif %}>{{ cidade.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="bairro" id="hero_bairro_3" class="form-select form-select-lg" disabled> <option value="">Bairro</option>
                                    </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100">Buscar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="carousel-item" style="background-image: url('{% static 'img/carousel/capa4.jpg' %}')">
            <div class="carousel-caption">
                <div class="text-center">
                    <h1 class="display-3 fw-bold mb-4">Qualidade e Confiança</h1>
                    
                    <div class="p-4 rounded-3" style="background-color: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                        <form method="GET" action="" class="row g-2 align-items-center justify-content-center">

                            <div class="col-md-4">
                                <select name="finalidade" class="form-select form-select-lg">
                                    <option value="">Comprar ou Alugar?</option>
                                    <option value="VENDA" {% if valores_filtro.finalidade|default:'' == 'VENDA' %}selected{% endif %}>Comprar</option>
                                    <option value="ALUGUEL" {% if valores_filtro.finalidade|default:'' == 'ALUGUEL' %}selected{% endif %}>Alugar</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="cidade" id="hero_cidade_4" class="form-select form-select-lg"> <option value="">Cidade</option>
                                    {% for cidade in cidades %}
                                        <option value="{{ cidade.id }}" {% if valores_filtro.cidade|default:'' == cidade.id|stringformat:"s" %}selected{% endif %}>{{ cidade.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="bairro" id="hero_bairro_4" class="form-select form-select-lg" disabled> <option value="">Bairro</option>
                                    </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100">Buscar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="carousel-item" style="background-image: url('{% static 'img/carousel/capa5.jpg' %}')">
            <div class="carousel-caption">
                <div class="text-center">
                    <h1 class="display-3 fw-bold mb-4">Seu Futuro Começa Aqui</h1>
                    
                    <div class="p-4 rounded-3" style="background-color: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                        <form method="GET" action="" class="row g-2 align-items-center justify-content-center">

                            <div class="col-md-4">
                                <select name="finalidade" class="form-select form-select-lg">
                                    <option value="">Comprar ou Alugar?</option>
                                    <option value="VENDA" {% if valores_filtro.finalidade|default:'' == 'VENDA' %}selected{% endif %}>Comprar</option>
                                    <option value="ALUGUEL" {% if valores_filtro.finalidade|default:'' == 'ALUGUEL' %}selected{% endif %}>Alugar</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="cidade" id="hero_cidade_5" class="form-select form-select-lg"> <option value="">Cidade</option>
                                    {% for cidade in cidades %}
                                        <option value="{{ cidade.id }}" {% if valores_filtro.cidade|default:'' == cidade.id|stringformat:"s" %}selected{% endif %}>{{ cidade.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="bairro" id="hero_bairro_5" class="form-select form-select-lg" disabled> <option value="">Bairro</option>
                                    </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100">Buscar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Anterior</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Próximo</span>
    </button>
</header>
{% if imobiliaria_selecionada %}
<div class="container mb-4 mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            Imóveis da <strong>{{ imobiliaria_selecionada.nome }}</strong>
        </div>
        <div class="card-body">
            <p class="card-text mb-0">
                {% if imobiliaria_selecionada.telefone %}
                    <strong>Telefone:</strong> {{ imobiliaria_selecionada.telefone }}
                {% endif %}
                {% if imobiliaria_selecionada.telefone_secundario %}
                    | <strong>WhatsApp:</strong> {{ imobiliaria_selecionada.telefone_secundario }}
                {% endif %}
                {% if imobiliaria_selecionada.site %}
                    | <strong>Site:</strong> <a href="{{ imobiliaria_selecionada.site }}" target="_blank">Acessar</a>
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="container mt-5">
    <div class="row">

        <div class="col-lg-3">
            <div class="p-4 bg-white rounded shadow-sm sticky-top" style="top: 100px;">
                <h4 class="mb-3">Filtro Avançado</h4>
                <form method="GET" action="">
                    <div class="mb-3">
                        <label class="form-label">Finalidade</label>
                        <select name="finalidade" class="form-select">
                            <option value="">Todas</option>
                            <option value="VENDA" {% if valores_filtro.finalidade|default:'' == 'VENDA' %}selected{% endif %}>Venda</option>
                            <option value="ALUGUEL" {% if valores_filtro.finalidade|default:'' == 'ALUGUEL' %}selected{% endif %}>Aluguel</option>
                        </select>
                    </div>

                     <div class="mb-3">
                        <label class="form-label">Cidade</label>
                        <select name="cidade" id="sidebar_cidade" class="form-select">
                            <option value="">Todas as cidades</option>
                            {% for cidade in cidades %}
                                <option value="{{ cidade.id }}" {% if valores_filtro.cidade|default:'' == cidade.id|stringformat:"s" %}selected{% endif %}>{{ cidade.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Bairro</label>
                        <select name="bairro" id="sidebar_bairro" class="form-select" disabled>
                            <option value="">Todos os bairros</option>
                            </select>
                    </div>

                    <div class="mb-3">
                        <label for="imobiliaria" class="form-label">Imobiliária</label>
                        <select name="imobiliaria" class="form-select">
                            <option value="">Todas</option>
                            {% for imobiliaria in imobiliarias %}
                                <option value="{{ imobiliaria.id }}" {% if valores_filtro.imobiliaria|default:'' == imobiliaria.id|stringformat:"s" %}selected{% endif %}>{{ imobiliaria.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6 mb-3">
                            <label for="quartos" class="form-label">Quartos (mín.)</label>
                            <input type="number" name="quartos" class="form-control" id="quartos" min="0" value="{{ valores_filtro.quartos|default_if_none:'' }}">
                        </div>
                        <div class="col-6 mb-3">
                            <label for="suites" class="form-label">Suítes (mín.)</label>
                            <input type="number" name="suites" class="form-control" id="suites" min="0" value="{{ valores_filtro.suites|default_if_none:'' }}">
                        </div>
                        <div class="col-6 mb-3">
                            <label for="banheiros" class="form-label">Banheiros (mín.)</label>
                            <input type="number" name="banheiros" class="form-control" id="banheiros" min="0" value="{{ valores_filtro.banheiros|default_if_none:'' }}">
                        </div>
                         <div class="col-6 mb-3">
                            <label for="salas" class="form-label">Salas (mín.)</label>
                            <input type="number" name="salas" class="form-control" id="salas" min="0" value="{{ valores_filtro.salas|default_if_none:'' }}">
                        </div>
                        <div class="col-6 mb-3">
                            <label for="cozinhas" class="form-label">Cozinhas (mín.)</label>
                            <input type="number" name="cozinhas" class="form-control" id="cozinhas" min="0" value="{{ valores_filtro.cozinhas|default_if_none:'' }}">
                        </div>
                         <div class="col-6 mb-3">
                            <label for="closets" class="form-label">Closets (mín.)</label>
                            <input type="number" name="closets" class="form-control" id="closets" min="0" value="{{ valores_filtro.closets|default_if_none:'' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="area" class="form-label">Área Mínima (m²)</label>
                        <input type="number" name="area" class="form-control" id="area" min="0" value="{{ valores_filtro.area|default_if_none:'' }}">
                    </div>
                    <div class="mb-3">
                        <label for="preco_max" class="form-label">Preço Máximo (R$)</label>
                        <input type="number" name="preco_max" class="form-control" id="preco_max" placeholder="Ex: 500000" value="{{ valores_filtro.preco_max|default_if_none:'' }}">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Aplicar Filtros</button>
                </form>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Imóveis para você</h3>
                {% if imoveis.paginator.count > 0 %}
                    <span class="text-muted"><small>Exibindo {{ imoveis.start_index }} - {{ imoveis.end_index }} de {{ imoveis.paginator.count }} resultados</small></span>
                {% endif %}
            </div>
            
            <div class="row row-cols-2 row-cols-lg-5 g-4">
                {% for imovel in imoveis %}
                    <div class="col">
                        <div class="card property-card h-100 {% if imovel.destaque %}card-destaque{% endif %}">
                            <div class="position-relative">
                                {% if imovel.destaque %}
                                    <div class="position-absolute top-0 end-0 p-2 text-white" style="background-color: var(--cor-destaque); border-top-right-radius: 12px; z-index: 10;">
                                        <i class="bi bi-star-fill"></i> Destaque
                                    </div>
                                {% endif %}
                                <span class="tag">{{ imovel.get_finalidade_display }}</span>
                                <a href="{% url 'detalhe_imovel' imovel.id %}">
                                    {% if imovel.foto_principal %}
                                        <img src="{{ imovel.foto_principal.url }}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="{{ imovel.titulo }}">
                                    {% else %}
                                        <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 150px;">Sem Foto</div>
                                    {% endif %}
                                </a>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-1"><small>{{ imovel.cidade.nome }}</small></p>
                                <h5 class="card-title mb-2" style="font-size: 0.9rem;">{{ imovel.titulo|truncatechars:35 }}</h5>
                                <p class="card-text fs-5 fw-bold mb-2" style="color: var(--cor-primaria);">R$ {{ imovel.preco|floatformat:2|intcomma }}</p>
                                
                                <div class="card-features border-top pt-2 mt-2" style="gap: 1rem; font-size: 0.8rem;">
                                    <span title="Quartos"><i class="bi bi-door-open-fill"></i> {{ imovel.quartos }}</span>
                                    <span title="Banheiros"><i class="bi bi-archive-fill"></i> {{ imovel.banheiros }}</span>
                                    <span title="Área"><i class="bi bi-arrows-fullscreen"></i> {{ imovel.area }} m²</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12">
                        <div class="alert alert-warning" role="alert">
                            Nenhum imóvel encontrado com os filtros selecionados.
                        </div>
                    </div>
                {% endfor %}
            </div>

            {% if imoveis.has_other_pages %}
            <nav aria-label="Navegação de páginas" class="mt-5 d-flex justify-content-center">
                <ul class="pagination">
                    {% if imoveis.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in valores_filtro.items %}{% if key != 'page' and value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" aria-label="Primeira">&laquo;</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in valores_filtro.items %}{% if key != 'page' and value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ imoveis.previous_page_number }}">Anterior</a>
                        </li>
                    {% endif %}

                    <li class="page-item active" aria-current="page">
                        <span class="page-link">Página {{ imoveis.number }} de {{ imoveis.paginator.num_pages }}</span>
                    </li>

                    {% if imoveis.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in valores_filtro.items %}{% if key != 'page' and value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ imoveis.next_page_number }}">Próxima</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in valores_filtro.items %}{% if key != 'page' and value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ imoveis.paginator.num_pages }}" aria-label="Última">&raquo;</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Passa o valor do filtro de bairro do Django para o JavaScript
        const bairroFiltradoId = "{{ valores_filtro.bairro|default_if_none:'' }}";

        // Função genérica para configurar os dropdowns de cidade/bairro
        function configurarDropdownBairros(idCidadeSelect, idBairroSelect) {
            const cidadeSelect = document.getElementById(idCidadeSelect);
            const bairroSelect = document.getElementById(idBairroSelect);
            
            if (!cidadeSelect || !bairroSelect) return;

            // Função para carregar os bairros
            function carregarBairros(cidadeId, bairroSelecionadoId = null) {
                if (!cidadeId) {
                    bairroSelect.innerHTML = '<option value="">Bairro</option>';
                    bairroSelect.disabled = true;
                    return;
                }

                bairroSelect.disabled = false;
                // Mostra "Carregando..." apenas se não estivermos pré-selecionando um valor
                if (!bairroSelecionadoId) {
                     bairroSelect.innerHTML = '<option value="">Carregando...</option>';
                }

                fetch(`/api/bairros/?cidade_id=${cidadeId}`)
                    .then(response => response.json())
                    .then(data => {
                        bairroSelect.innerHTML = '<option value="">Bairro</option>';
                        data.forEach(function(bairro) {
                            const option = new Option(bairro.nome, bairro.id);
                            // Verifica se o ID do bairro atual é o mesmo que o bairro filtrado
                            if (bairro.id == bairroSelecionadoId) {
                                option.selected = true;
                            }
                            bairroSelect.add(option);
                        });
                    });
            }

            // Evento de mudança na cidade
            cidadeSelect.addEventListener('change', function() {
                // Ao mudar a cidade manualmente, não passamos um bairro pré-selecionado
                carregarBairros(this.value, null);
            });

            // Carga Inicial: Carrega os bairros para a cidade já selecionada (se houver)
            const cidadeInicial = cidadeSelect.value;
            if (cidadeInicial) {
                 carregarBairros(cidadeInicial, bairroFiltradoId);
            } else {
                 bairroSelect.disabled = true;
            }
        }

        // --- [INÍCIO] ATUALIZAÇÃO DO CARROSSEL ---
        // Configura para a barra de busca principal (Hero)
        configurarDropdownBairros('hero_cidade', 'hero_bairro');
        // Configura para os outros 4 slides
        configurarDropdownBairros('hero_cidade_2', 'hero_bairro_2');
        configurarDropdownBairros('hero_cidade_3', 'hero_bairro_3');
        configurarDropdownBairros('hero_cidade_4', 'hero_bairro_4');
        configurarDropdownBairros('hero_cidade_5', 'hero_bairro_5');
        // --- [FIM] ATUALIZAÇÃO DO CARROSSEL ---

        // Configura para a barra lateral (Sidebar)
        configurarDropdownBairros('sidebar_cidade', 'sidebar_bairro');
    });
</script>
{% endblock %}